<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <script src="https://cdn.jsdelivr.net/npm/jsencrypt@3.2.1/bin/jsencrypt.min.js"
         integrity="sha512-hI8jEOQLtyzkIiWVygLAcKPradIhgXQUl8I3lk2FUmZ8sZNbSSdHHrWo5mrmsW1Aex+oFZ+UUK7EJTVwyjiFLA=="
         crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/gun@0.2020.1235/gun.js"
         integrity="sha512-F7/rW8ee5HU9r0zrXffpHjsPHtZCKW0OE1+BWnK+9eUV+kkosMtiDx9FwpNzEwY1tSXEvGVwf47zgs1X51eUmA=="
         crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/gun@0.2020.1235/sea.js"
         integrity="sha256-HiuxN/UJBpWtE2s3NbooyWHrbxjQFKDu3Q8ybsHv+8w=" crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"
         integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
      <title>Document</title>
   </head>
   <body>
      <form id="sign">
         <input id="alias" placeholder="username" required/>
         <input id="pass" type="password" placeholder="passphrase" required/>
         <input id="in" type="submit" value="sign in" />
         <input id="up" type="button" value="sign up" />
      </form>
      <form id="chat" style="display: none;">
         <input id="request" type="text" placeholder="invite code" title="public key" required/>
         <input type="submit" value="Ok" />
      </form>
      </form>
      <div id="btns" style="display: none;">
        <button id="rBtn" onclick="recivedMessageDisplay()" type="button">Recived</button>
        <button id="sBtn" onclick="sentMessageDisplay()" type="button">Sent</button>
        <button id="cBtn" onclick="copyPublicKey()" type="button">Copy Public Key</button>
      </div>
      <div id="list">
      </div>
      <script>
         let sign = false;
         let pkey = "";
         const getCharCodes = (s) => {
           let charCodeArr = [];
           for (let i = 0; i < s.length; i++) {
             let code = s.charCodeAt(i);
             charCodeArr.push(code);
           }
           charCodeArr.reduce((a, b) => a + b, 0)
           return charCodeArr;
         }
         const code = (s) => {
           let sum = getCharCodes(s).reduce((a, b) => a + b, 0)
           sum = sum.toString()
           sum = "Z" + sum
           return sum;
         }
         const en = (key, data) => {
          let encrypt = new JSEncrypt();
          encrypt.setPublicKey(key);
          let enc = encrypt.encrypt(data);
          return enc
         }

         const de = (key, data) => {
          var decrypt = new JSEncrypt();
          decrypt.setPrivateKey(key);
          var uncrypted = decrypt.decrypt(data);
          return uncrypted
         }

         const copyPublicKey = () => {
          let t = {
            username: $("#alias").val(),
            pubkey: JSON.parse(localStorage.getItem($("#alias").val())).pub
          }
          t = JSON.stringify(t)
          var input = document.createElement("input");
          input.setAttribute("value", t);
          document.body.appendChild(input);
          input.select();
          var result = document.execCommand("copy");
          document.body.removeChild(input);
          alert("Copied!")
          return result;
         }
        
         const gun = Gun([
           "http://localhost:8000/gun",
           "https://gun-server-1.herokuapp.com/gun",
         ]);
         
         const user = gun.user();
         
         $("#up").on("click", function (e) {
           user.create($("#alias").val(), $("#pass").val());
           let obj = new JSEncrypt({ default_key_size: 1024 });
           obj.getKey();
           let public = obj.getPublicKey();
           let private = obj.getPrivateKey();
           public = public.replace(/(\r\n|\n|\r)/gm, "")
           private = private.replace(/(\r\n|\n|\r)/gm, "")
           let temp = {
             pub: public,
             pri: private
           }
           localStorage.setItem($("#alias").val(), JSON.stringify(temp))
         });
         
         $("#sign").on("submit", function (e) {
           e.preventDefault();
           user.auth($("#alias").val(), $("#pass").val());
         });
         
         gun.on("auth", function () {
           console.log("auth");
           sign = true;
           $("#sign").hide()
           $("#btns").show()
           $("#chat").show()
         });
         
         $("#chat").on("submit", function (e) {
           e.preventDefault();
           let pub = JSON.parse($("#request").val()).pubkey
           console.log(pub)
           temp = gun.get(code(pub)).get($("#alias").val())
           let t = {
             pkey: JSON.parse(localStorage.getItem($("#alias").val())).pub,
           }
           temp.get("sent").set(JSON.stringify(t));
         });
         
         const recivedMessageDisplay = () => {
           if (sign) {
             let publicKey = JSON.parse(localStorage.getItem($("#alias").val())).pub
             let myPriKey = JSON.parse(localStorage.getItem($("#alias").val())).pri
             let pubKey = code(publicKey)
             gun.get(code(publicKey)).once(() => {
                gun.get(code(publicKey)).once((doc) => {
                   Object.keys(doc).forEach(key => {
                     if (key != "_") {
                       let div = document.createElement(key)
                       $("#list").append(`<div id="${key}"><h3>${key} - Started The Chat!</h3><ul></ul><form id="fr${key}"><input id="r${key}" type="text" placeholder="Type Message..." required/><input type="submit" value="send"/></form></div>`)
                       $(`#fr${key}`).on("submit", function (e) {
                         e.preventDefault();
                         temp = gun.get(pubKey).get(key).get("sent")
                         let r = en( pkey, `${$(`#r${key}`).val()}`)
                         let s = en( publicKey, `${$(`#r${key}`).val()}`)
                         let t = {
                           s: s,
                           r: r
                         }
                         temp.set(JSON.stringify(t));
                         $(`#r${key}`).val("");
                       })
                       let t = gun.get(pubKey).get(key).get("sent")
                       let con = false;
                       t.map().once(data => {
                         let temp = JSON.parse(data);
                         let send = true;
                         if (con){
                           if (data) {
                             let message = de(myPriKey, temp.s)
                             if (message == false || message == null) {
                               message = de(myPriKey, temp.r);
                               send = false
                            }
                            let li = document.createElement("li");
                             let text = document.createTextNode(`${send ? $("#alias").val() : key}: ${message}`);
                             li.appendChild(text)
                             $(`#${key} ul`).append(li)
                           }
                         } else {
                           pkey = temp.pkey
                           con = true;
                         }
                       })
                     }
                   })
                  
                } )
             })
           } else {
             console.log("Enter Public Key")
           }
         }
         
         const sentMessageDisplay = () => {
           if (sign) {
             let publicKey = JSON.parse($("#request").val()).pubkey
             let myPublicKey = JSON.parse(localStorage.getItem($("#alias").val())).pub
             let myPriKey = JSON.parse(localStorage.getItem($("#alias").val())).pri
             let pubKey = code(publicKey)
             let username = JSON.parse($("#request").val()).username
             gun.get(code(publicKey)).once(() => {
                gun.get(code(publicKey)).once((doc) => {
                  Object.keys(doc).forEach(key => {
                    if (key == $("#alias").val()) {
                      let div = document.createElement(key)
                      $("#list").append(`<div id="${key}"><h3>${key} - Started The Chat!</h3><ul></ul><form id="f${key}"><input id="i${key}" type="text" placeholder="Type Message..." required/><input type="submit" value="send"/></form></div>`)
                      $(`#f${key}`).on("submit", function (e) {
                        e.preventDefault();
                        temp = gun.get(pubKey).get($("#alias").val()).get("sent")
                        let r = en( publicKey, `${$(`#i${key}`).val()}`)
                        let s = en( myPublicKey, `${$(`#i${key}`).val()}`)
                        let t = {
                          s: s,
                          r: r
                        }
                        temp.set(JSON.stringify(t));
                        $(`#i${key}`).val("");
                      })
                      let t = gun.get(pubKey).get(key).get("sent")
                      t.map().once(data => {
                        let temp = JSON.parse(data)
                        let send = true;
                        if (temp) {
                          let message = de(myPriKey, temp.s)
                          if (!message) {
                            message = de(myPriKey, temp.r);
                            send = false
                          }
     
                          let li = document.createElement("li");
                          let text = document.createTextNode(`${send ? $("#alias").val() : username}: ${message}`);
                          li.appendChild(text)
                          $(`#${key} ul`).append(li)
                        }
                      })
                    }
                  })

                })
            })
           } else {
             console.log("Enter Public Key")
           }
         }

       
      </script>
   </body>
</html>